<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Puter.js Demo App</title>
<link rel="preconnect" href="https://js.puter.com">
<style>
/* Minimal, readable styling */
:root { --bg:#0f1221; --panel:#161a2f; --muted:#99a2c2; --text:#e6ecff; --primary:#4f7cff; }
* { box-sizing: border-box; }
body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
header { padding: 20px; text-align: center; border-bottom: 1px solid #23284a; }
.container { max-width: 1100px; margin: 0 auto; padding: 20px; }
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
.card { background: var(--panel); border: 1px solid #23284a; border-radius: 10px; padding: 16px; }
.card h2 { margin: 0 0 10px; font-size: 18px; }
.card p.helper { margin: 0 0 12px; color: var(--muted); font-size: 13px; }
label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
input[type="text"], input[type="url"], textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #2a2f55; background: #101431; color: var(--text); }
textarea { min-height: 90px; resize: vertical; }
button { background: var(--primary); color: white; border: 0; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
button:disabled { opacity: .6; cursor: not-allowed; }
.row { display:flex; gap: 10px; align-items: center; flex-wrap: wrap; }
small.mono { display:block; color: var(--muted); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; margin-top: 6px; }
.output { background: #0c0f24; border: 1px dashed #2a2f55; border-radius: 8px; padding: 10px; min-height: 52px; white-space: pre-wrap; overflow: auto; }
img.preview { max-width: 100%; border-radius: 8px; border: 1px solid #2a2f55; background: #0c0f24; }
footer { margin-top: 30px; padding: 20px; text-align: center; color: var(--muted); border-top: 1px solid #23284a; }
footer a { color: var(--muted); text-decoration: underline; }
.notice { background: #162046; border: 1px solid #23316a; padding: 10px; border-radius: 8px; font-size: 13px; color: #c6d1ff; }
</style>
</head>
<body>
<header>
  <h1>Puter.js Demo App</h1>
  <div class="notice">This frontend-only app showcases AI and Cloud features via Puter.js. No backend or API keys required.</div>
</header>
<div class="container">
  <div class="grid">
    <section class="card" id="ai-chat">
      <h2>AI Chat</h2>
      <p class="helper">Chat with a model. Optionally stream the response.</p>
      <label for="chat-model">Model (optional)</label>
      <input id="chat-model" type="text" placeholder="e.g. gpt-5-nano, claude, gemini ... (optional)">
      <label for="chat-prompt">Prompt</label>
      <textarea id="chat-prompt" placeholder="Ask anything..."></textarea>
      <div class="row">
        <label><input id="chat-stream" type="checkbox"> Stream response</label>
        <button id="chat-send">Send</button>
        <button id="chat-clear" type="button">Clear</button>
      </div>
      <small class="mono">Tip: If model is empty, default vendor/model is used.</small>
      <div id="chat-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="ocr">
      <h2>Image → Text (OCR)</h2>
      <p class="helper">Extract text from an image URL.</p>
      <label for="ocr-url">Image URL</label>
      <input id="ocr-url" type="url" placeholder="https://...">
      <div class="row">
        <button id="ocr-run">Extract</button>
      </div>
      <div id="ocr-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="txt2img">
      <h2>Text → Image</h2>
      <p class="helper">Generate an image from text.</p>
      <label for="img-prompt">Prompt</label>
      <input id="img-prompt" type="text" placeholder="A serene watercolor of mountains at sunrise">
      <div class="row">
        <button id="img-generate">Generate</button>
      </div>
      <div id="img-output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="tts">
      <h2>Text → Speech</h2>
      <p class="helper">Convert text to speech and play.</p>
      <label for="tts-text">Text</label>
      <textarea id="tts-text" placeholder="Hello world! This will be spoken aloud."></textarea>
      <div class="row">
        <label for="tts-lang">Language</label>
        <input id="tts-lang" type="text" placeholder="en-US">
        <label for="tts-voice">Voice</label>
        <input id="tts-voice" type="text" placeholder="Joanna">
        <button id="tts-play">Speak</button>
      </div>
      <div id="tts-status" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="fs">
      <h2>Cloud Storage Demo</h2>
      <p class="helper">Write a file to your Puter cloud, then read it.</p>
      <label for="fs-filename">Filename</label>
      <input id="fs-filename" type="text" placeholder="hello.txt">
      <label for="fs-content">Content</label>
      <textarea id="fs-content" placeholder="Hello, world!"></textarea>
      <div class="row">
        <button id="fs-write">Write File</button>
        <button id="fs-read">Read File</button>
      </div>
      <div id="fs-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="auth">
      <h2>Auth</h2>
      <p class="helper">Sign in/out, check status, and get user.</p>
      <div class="row">
        <button id="auth-signin">Sign In</button>
        <button id="auth-signout" type="button">Sign Out</button>
        <button id="auth-status" type="button">Is Signed In?</button>
        <button id="auth-user" type="button">Get User</button>
      </div>
      <div id="auth-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="kv">
      <h2>Key-Value Store</h2>
      <p class="helper">Set, get, list, delete keys; flush store.</p>
      <label for="kv-key">Key</label>
      <input id="kv-key" type="text" placeholder="name">
      <label for="kv-value">Value (JSON allowed)</label>
      <input id="kv-value" type="text" placeholder="\"Puter Smith\" or 123 or {\"a\":1}">
      <div class="row">
        <button id="kv-set">Set</button>
        <button id="kv-get">Get</button>
        <button id="kv-del">Delete</button>
        <button id="kv-list">List Keys</button>
        <button id="kv-flush">Flush</button>
      </div>
      <div id="kv-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="hosting">
      <h2>Hosting</h2>
      <p class="helper">Create a simple site; update or delete.</p>
      <div class="row">
        <button id="host-create-demo">Create Demo Site</button>
      </div>
      <label for="host-subdomain">Subdomain</label>
      <input id="host-subdomain" type="text" placeholder="my-cool-site">
      <label for="host-dir">Directory Path</label>
      <input id="host-dir" type="text" placeholder="example-dir">
      <div class="row">
        <button id="host-update">Update Dir</button>
        <button id="host-delete">Delete Site</button>
        <button id="host-get">Get</button>
        <button id="host-list">List</button>
      </div>
      <div id="hosting-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="networking">
      <h2>Networking</h2>
      <p class="helper">Fetch a URL (no CORS). Optional raw sockets.</p>
      <label for="net-url">URL to fetch</label>
      <input id="net-url" type="url" placeholder="https://example.com">
      <div class="row">
        <button id="net-fetch">Fetch</button>
      </div>
      <small class="mono">Socket demos fetch example.com headers.</small>
      <div class="row" style="margin-top:8px;">
        <button id="net-socket">TCP Socket</button>
        <button id="net-tls">TLS Socket</button>
      </div>
      <div id="networking-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="workers">
      <h2>Workers</h2>
      <p class="helper">Deploy a tiny worker and test an endpoint.</p>
      <div class="row">
        <button id="worker-deploy">Deploy Worker</button>
        <button id="worker-test">Test /api/hello</button>
      </div>
      <small class="mono">Deploy then wait ~5–15s before testing.</small>
      <div id="workers-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="ui-pickers">
      <h2>UI & Pickers</h2>
      <p class="helper">Open/save files or dirs; color & font pickers; language.</p>
      <div class="row">
        <button id="ui-open-file">Open File</button>
        <button id="ui-save-file">Save File</button>
        <button id="ui-open-dir">Open Directory</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="ui-color">Pick Color</button>
        <button id="ui-font">Pick Font</button>
        <button id="ui-language">Get Language</button>
      </div>
      <div id="ui-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="fs-extras">
      <h2>FS Extras</h2>
      <p class="helper">Make directory and list items.</p>
      <label for="mkdir-path">Directory Path</label>
      <input id="mkdir-path" type="text" placeholder="my-directory/another-directory">
      <div class="row">
        <button id="fs-mkdir">mkdir</button>
      </div>
      <label for="readdir-path" style="margin-top:8px;">Read Dir Path</label>
      <input id="readdir-path" type="text" placeholder="./">
      <div class="row">
        <button id="fs-readdir">readdir</button>
      </div>
      <div id="fsx-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="apps">
      <h2>Apps API</h2>
      <p class="helper">Create/list/get/update/delete apps.</p>
      <label for="apps-name">App Name</label>
      <input id="apps-name" type="text" placeholder="my-demo-app">
      <label for="apps-index">Index URL</label>
      <input id="apps-index" type="url" placeholder="https://example.com">
      <div class="row" style="margin-top:8px;">
        <button id="apps-create">Create</button>
        <button id="apps-list">List</button>
        <button id="apps-get">Get</button>
        <button id="apps-update">Update Title</button>
        <button id="apps-delete">Delete</button>
      </div>
      <div id="apps-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="fs-more">
      <h2>FS: rename/copy/move/delete/stat/readURL/upload</h2>
      <p class="helper">Demonstrate more filesystem ops.</p>
      <label for="fs-src">Source Path</label>
      <input id="fs-src" type="text" placeholder="hello.txt">
      <label for="fs-dest">Destination Path/Dir</label>
      <input id="fs-dest" type="text" placeholder="new-dir or new-name.txt">
      <div class="row" style="margin-top:8px;">
        <button id="fs-rename">rename</button>
        <button id="fs-copy">copy</button>
        <button id="fs-move">move</button>
        <button id="fs-delete">delete</button>
        <button id="fs-stat">stat</button>
        <button id="fs-readurl">getReadURL</button>
        <button id="fs-upload">upload…</button>
        <button id="fs-space">space</button>
      </div>
      <div id="fs-more-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="kv-incdec">
      <h2>KV incr/decr</h2>
      <p class="helper">Increment or decrement numeric values.</p>
      <label for="kvid-key">Key</label>
      <input id="kvid-key" type="text" placeholder="counter">
      <div class="row" style="margin-top:8px;">
        <button id="kv-incr">incr</button>
        <button id="kv-decr">decr</button>
      </div>
      <div id="kvid-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="workers-more">
      <h2>Workers list/get/delete</h2>
      <p class="helper">Inspect and remove workers.</p>
      <label for="workers-name">Worker Name</label>
      <input id="workers-name" type="text" placeholder="name from list">
      <div class="row" style="margin-top:8px;">
        <button id="workers-list">List</button>
        <button id="workers-get">Get</button>
        <button id="workers-delete">Delete</button>
      </div>
      <div id="workers-more-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="ui-extras">
      <h2>UI Extras</h2>
      <p class="helper">Alert, window, spinner, context menu, menubar, social share.</p>
      <div class="row">
        <button id="ui-alert">Alert</button>
        <button id="ui-prompt">Prompt</button>
        <button id="ui-window">Create Window</button>
        <button id="ui-spinner">Show Spinner (3s)</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="ui-context">Context Menu (right-click area)</button>
        <button id="ui-menubar">Set Menubar</button>
        <button id="ui-share">Social Share</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="ui-authenticate">Authenticate With Puter</button>
        <button id="ui-launch-app">Launch This App</button>
        <button id="ui-parent-app">Check Parent App</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="ui-on-register">Register on() Handlers</button>
        <button id="ui-on-window-close">onWindowClose</button>
        <button id="ui-items-handlers">Items Handlers</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="ui-title">Set Title</button>
        <button id="ui-size">Set Size</button>
        <button id="ui-position">Set Position</button>
        <button id="ui-width">Set Width</button>
        <button id="ui-height">Set Height</button>
        <button id="ui-x">Set X</button>
        <button id="ui-y">Set Y</button>
      </div>
      <div id="ui-context-area" style="margin-top:10px; padding:10px; border:1px dashed #2a2f55; border-radius:8px;">Right-click inside this box for context menu</div>
      <div id="ui-extras-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="utils">
      <h2>Utils</h2>
      <p class="helper">env, appID, randName</p>
      <div class="row">
        <button id="util-env">Show Env</button>
        <button id="util-appid">Show App ID</button>
        <button id="util-rand">Generate Name</button>
        <button id="util-print">puter.print Demo</button>
      </div>
      <div id="utils-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="drivers">
      <h2>Drivers.call</h2>
      <p class="helper">Low-level driver call (example placeholders).</p>
      <label for="drv-interface">Interface</label>
      <input id="drv-interface" type="text" placeholder="exampleInterface">
      <label for="drv-driver">Driver</label>
      <input id="drv-driver" type="text" placeholder="exampleDriver">
      <label for="drv-method">Method</label>
      <input id="drv-method" type="text" placeholder="exampleMethod">
      <label for="drv-args">Args (JSON)</label>
      <input id="drv-args" type="text" placeholder="{ }">
      <div class="row" style="margin-top:8px;">
        <button id="drv-call">Call</button>
      </div>
      <div class="notice" style="margin-top:10px;">Note: This may require privileged environment. Example is illustrative.</div>
      <div id="drivers-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="perms">
      <h2>Perms (may require privilege)</h2>
      <p class="helper">Grant/revoke example calls with try/catch.</p>
      <label for="perms-app-uid">App UID</label>
      <input id="perms-app-uid" type="text" placeholder="app-xxxxxxxxx">
      <label for="perms-origin">Origin</label>
      <input id="perms-origin" type="text" placeholder="https://example.com">
      <label for="perms-group-uid">Group UID</label>
      <input id="perms-group-uid" type="text" placeholder="550e8400-e29b-41d4-a716-446655440000">
      <label for="perms-username">Username</label>
      <input id="perms-username" type="text" placeholder="alice">
      <label for="perms-string">Permission String</label>
      <input id="perms-string" type="text" placeholder="fs:SOME-FILE:read">
      <div class="row" style="margin-top:8px;">
        <button id="perms-grant-app">grantApp</button>
        <button id="perms-revoke-app">revokeApp</button>
        <button id="perms-grant-app-any">grantAppAnyUser</button>
        <button id="perms-revoke-app-any">revokeAppAnyUser</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="perms-grant-origin">grantOrigin</button>
        <button id="perms-revoke-origin">revokeOrigin</button>
        <button id="perms-grant-group">grantGroup</button>
        <button id="perms-revoke-group">revokeGroup</button>
        <button id="perms-grant-user">grantUser</button>
        <button id="perms-revoke-user">revokeUser</button>
      </div>
      <div id="perms-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="ai-advanced">
      <h2>AI Advanced</h2>
      <p class="helper">Chat with image/messages/tools; txt2img options; tts engine.</p>
      <div class="row">
        <button id="ai-chat-image">Chat with Image URL</button>
        <button id="ai-chat-messages">Chat with Messages[]</button>
        <button id="ai-chat-tools">Chat with Tools (demo)</button>
      </div>
      <label for="ai-img-url" style="margin-top:8px;">Image URL</label>
      <input id="ai-img-url" type="url" placeholder="https://assets.puter.site/doge.jpeg">
      <label for="ai-msg-text">Messages Text</label>
      <input id="ai-msg-text" type="text" placeholder="Say hello in 1 sentence">
      <div class="row" style="margin-top:8px;">
        <label for="ai-txt2img-model">txt2img model</label>
        <input id="ai-txt2img-model" type="text" placeholder="gpt-image-1 or dall-e-3">
        <label for="ai-txt2img-quality">quality</label>
        <input id="ai-txt2img-quality" type="text" placeholder="low|medium|high|hd|standard">
        <button id="ai-txt2img-opts">Generate (opts)</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="ai-i2i-file" type="file" accept="image/*">
        <input id="ai-i2i-prompt" type="text" placeholder="Describe transformation (e.g., add a hat)">
        <button id="ai-txt2img-i2i">Generate (image-to-image)</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <label for="tts-engine">TTS engine</label>
        <input id="tts-engine" type="text" placeholder="standard|neural|generative">
        <button id="tts-play-engine">Speak (engine)</button>
      </div>
      <div id="ai-advanced-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="auth-advanced">
      <h2>Auth Advanced</h2>
      <p class="helper">signIn with options</p>
      <div class="row">
        <button id="auth-temp-user">Sign In (attempt_temp_user_creation)</button>
      </div>
      <div id="auth-advanced-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="kv-advanced">
      <h2>KV Advanced</h2>
      <p class="helper">list with pattern and returnValues</p>
      <label for="kv-pattern">Pattern</label>
      <input id="kv-pattern" type="text" placeholder="user*">
      <div class="row" style="margin-top:8px;">
        <button id="kv-list-pattern">List (pattern)</button>
        <button id="kv-list-values">List (values=true)</button>
      </div>
      <div id="kv-advanced-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="fs-read-advanced">
      <h2>FS Read (offset/byte_count)</h2>
      <p class="helper">Read part of a file.</p>
      <label for="fs-read-path">File Path</label>
      <input id="fs-read-path" type="text" placeholder="hello.txt">
      <div class="row" style="margin-top:8px;">
        <label for="fs-offset">offset</label>
        <input id="fs-offset" type="number" placeholder="0" style="width:100px;">
        <label for="fs-bytecount">byte_count</label>
        <input id="fs-bytecount" type="number" placeholder="5" style="width:100px;">
        <button id="fs-read-slice">Read Slice</button>
      </div>
      <div id="fs-read-advanced-output" class="output" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="net-post">
      <h2>Networking POST</h2>
      <p class="helper">net.fetch with method, headers, body.</p>
      <label for="net-post-url">URL</label>
      <input id="net-post-url" type="url" placeholder="https://httpbin.org/post">
      <label for="net-post-body">JSON Body</label>
      <input id="net-post-body" type="text" placeholder='{ "hello": "world" }'>
      <div class="row" style="margin-top:8px;">
        <button id="net-post-send">POST</button>
      </div>
      <div id="net-post-output" class="output" style="margin-top:10px;"></div>
    </section>
  </div>

  <footer>
    <span>Powered by </span><a href="https://developer.puter.com" target="_blank" rel="noopener">Puter</a>
  </footer>
</div>

<script src="https://js.puter.com/v2/"></script>
<script>
// Utilities
function setBusy(btn, busy) {
  if (!btn) return;
  btn.disabled = !!busy;
  if (busy) { btn.dataset.__label = btn.textContent; btn.textContent = 'Working...'; }
  else if (btn.dataset.__label) { btn.textContent = btn.dataset.__label; delete btn.dataset.__label; }
}

// AI Chat
const chatSendBtn = document.getElementById('chat-send');
const chatClearBtn = document.getElementById('chat-clear');
chatSendBtn.addEventListener('click', async () => {
  const model = document.getElementById('chat-model').value.trim();
  const prompt = document.getElementById('chat-prompt').value.trim();
  const stream = document.getElementById('chat-stream').checked;
  const out = document.getElementById('chat-output');
  if (!prompt) { out.textContent = 'Enter a prompt.'; return; }
  out.textContent = '';
  setBusy(chatSendBtn, true);
  try {
    if (stream) {
      const resp = await puter.ai.chat(prompt, { model: model || undefined, stream: true });
      for await (const part of resp) {
        if (part?.text) out.textContent += part.text;
      }
    } else {
      const resp = await puter.ai.chat(prompt, { model: model || undefined });
      const text = typeof resp === 'string' ? resp : (resp?.message?.content || resp?.toString?.() || '');
      out.textContent = text;
    }
  } catch (e) {
    out.textContent = 'Error: ' + (e?.message || e);
  } finally {
    setBusy(chatSendBtn, false);
  }
});
chatClearBtn.addEventListener('click', () => {
  document.getElementById('chat-prompt').value = '';
  document.getElementById('chat-output').textContent = '';
});

// OCR
document.getElementById('ocr-run').addEventListener('click', async (e) => {
  const btn = e.currentTarget;
  const url = document.getElementById('ocr-url').value.trim();
  const out = document.getElementById('ocr-output');
  if (!url) { out.textContent = 'Provide an image URL.'; return; }
  out.textContent = '';
  setBusy(btn, true);
  try {
    const text = await puter.ai.img2txt(url);
    out.textContent = text;
  } catch (err) {
    out.textContent = 'Error: ' + (err?.message || err);
  } finally {
    setBusy(btn, false);
  }
});

// Text to Image
document.getElementById('img-generate').addEventListener('click', async (e) => {
  const btn = e.currentTarget;
  const prompt = document.getElementById('img-prompt').value.trim();
  const out = document.getElementById('img-output');
  if (!prompt) { out.textContent = 'Enter a prompt.'; return; }
  out.innerHTML = '';
  setBusy(btn, true);
  try {
    const imgEl = await puter.ai.txt2img(prompt);
    if (imgEl instanceof HTMLImageElement) {
      imgEl.classList.add('preview');
      out.appendChild(imgEl);
    } else if (typeof imgEl === 'string') {
      const img = new Image();
      img.src = imgEl; img.className = 'preview';
      out.appendChild(img);
    } else {
      out.textContent = 'Image generated (unknown format).';
    }
  } catch (err) {
    out.textContent = 'Error: ' + (err?.message || err);
  } finally {
    setBusy(btn, false);
  }
});

// Text to Speech
document.getElementById('tts-play').addEventListener('click', async (e) => {
  const btn = e.currentTarget;
  const text = document.getElementById('tts-text').value.trim();
  const language = document.getElementById('tts-lang').value.trim() || 'en-US';
  const voice = document.getElementById('tts-voice').value.trim() || 'Joanna';
  const out = document.getElementById('tts-status');
  if (!text) { out.textContent = 'Enter text to speak.'; return; }
  out.textContent = '';
  setBusy(btn, true);
  try {
    const audio = await puter.ai.txt2speech(text, { language, voice });
    await audio.play();
    out.textContent = 'Playing.';
  } catch (err) {
    out.textContent = 'Error: ' + (err?.message || err);
  } finally {
    setBusy(btn, false);
  }
});

// Cloud FS
const fsWriteBtn = document.getElementById('fs-write');
const fsReadBtn = document.getElementById('fs-read');
fsWriteBtn.addEventListener('click', async () => {
  const filename = (document.getElementById('fs-filename').value || '').trim();
  const content = document.getElementById('fs-content').value;
  const out = document.getElementById('fs-output');
  if (!filename) { out.textContent = 'Enter a filename.'; return; }
  out.textContent = '';
  setBusy(fsWriteBtn, true);
  try {
    const file = await puter.fs.write(filename, content);
    out.textContent = `Wrote ${file?.name || filename} at ${file?.path || filename}`;
  } catch (err) {
    out.textContent = 'Error: ' + (err?.message || err);
  } finally {
    setBusy(fsWriteBtn, false);
  }
});
fsReadBtn.addEventListener('click', async () => {
  const filename = (document.getElementById('fs-filename').value || '').trim();
  const out = document.getElementById('fs-output');
  if (!filename) { out.textContent = 'Enter a filename.'; return; }
  out.textContent = '';
  setBusy(fsReadBtn, true);
  try {
    const blob = await puter.fs.read(filename);
    const text = await blob.text();
    out.textContent = text;
  } catch (err) {
    out.textContent = 'Error: ' + (err?.message || err);
  } finally {
    setBusy(fsReadBtn, false);
  }
});

// Auth
(() => {
  const out = document.getElementById('auth-output');
  const signInBtn = document.getElementById('auth-signin');
  const signOutBtn = document.getElementById('auth-signout');
  const statusBtn = document.getElementById('auth-status');
  const userBtn = document.getElementById('auth-user');

  signInBtn?.addEventListener('click', async () => {
    setBusy(signInBtn, true);
    try {
      const res = await puter.auth.signIn();
      out.textContent = 'Signed in: ' + JSON.stringify(res);
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    } finally {
      setBusy(signInBtn, false);
    }
  });

  signOutBtn?.addEventListener('click', async () => {
    setBusy(signOutBtn, true);
    try {
      await puter.auth.signOut();
      out.textContent = 'Signed out.';
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    } finally {
      setBusy(signOutBtn, false);
    }
  });

  statusBtn?.addEventListener('click', () => {
    try {
      const isIn = puter.auth.isSignedIn();
      out.textContent = 'isSignedIn: ' + isIn;
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    }
  });

  userBtn?.addEventListener('click', async () => {
    setBusy(userBtn, true);
    try {
      const user = await puter.auth.getUser();
      out.textContent = JSON.stringify(user);
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    } finally {
      setBusy(userBtn, false);
    }
  });
})();

// KV Store
(() => {
  const out = document.getElementById('kv-output');
  const keyEl = document.getElementById('kv-key');
  const valEl = document.getElementById('kv-value');
  const btnSet = document.getElementById('kv-set');
  const btnGet = document.getElementById('kv-get');
  const btnDel = document.getElementById('kv-del');
  const btnList = document.getElementById('kv-list');
  const btnFlush = document.getElementById('kv-flush');

  btnSet?.addEventListener('click', async () => {
    const key = keyEl.value.trim();
    if (!key) { out.textContent = 'Enter a key.'; return; }
    let valueRaw = valEl.value;
    let value;
    try { value = JSON.parse(valueRaw); } catch { value = valueRaw; }
    setBusy(btnSet, true);
    try {
      await puter.kv.set(key, value);
      out.textContent = 'Set OK';
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnSet, false); }
  });

  btnGet?.addEventListener('click', async () => {
    const key = keyEl.value.trim();
    if (!key) { out.textContent = 'Enter a key.'; return; }
    setBusy(btnGet, true);
    try {
      const v = await puter.kv.get(key);
      out.textContent = 'Value: ' + JSON.stringify(v);
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnGet, false); }
  });

  btnDel?.addEventListener('click', async () => {
    const key = keyEl.value.trim();
    if (!key) { out.textContent = 'Enter a key.'; return; }
    setBusy(btnDel, true);
    try { await puter.kv.del(key); out.textContent = 'Deleted.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnDel, false); }
  });

  btnList?.addEventListener('click', async () => {
    setBusy(btnList, true);
    try {
      const keys = await puter.kv.list();
      out.textContent = 'Keys: ' + JSON.stringify(keys);
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnList, false); }
  });

  btnFlush?.addEventListener('click', async () => {
    setBusy(btnFlush, true);
    try { await puter.kv.flush(); out.textContent = 'Flushed.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnFlush, false); }
  });
})();

// Hosting
(() => {
  const out = document.getElementById('hosting-output');
  const createBtn = document.getElementById('host-create-demo');
  const updateBtn = document.getElementById('host-update');
  const deleteBtn = document.getElementById('host-delete');
  const subdomainEl = document.getElementById('host-subdomain');
  const dirEl = document.getElementById('host-dir');

  createBtn?.addEventListener('click', async () => {
    setBusy(createBtn, true);
    out.textContent = '';
    try {
      const dirName = puter.randName();
      await puter.fs.mkdir(dirName);
      await puter.fs.write(`${dirName}/index.html`, '<h1>Hello, world!</h1>');
      const sd = subdomainEl.value.trim() || puter.randName();
      const site = await puter.hosting.create(sd, dirName);
      subdomainEl.value = site.subdomain;
      dirEl.value = dirName;
      out.innerHTML = `Website hosted at: https://${site.subdomain}.puter.site`;
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    } finally { setBusy(createBtn, false); }
  });

  updateBtn?.addEventListener('click', async () => {
    const sd = subdomainEl.value.trim();
    const dp = dirEl.value.trim();
    if (!sd) { out.textContent = 'Enter subdomain.'; return; }
    setBusy(updateBtn, true);
    try { await puter.hosting.update(sd, dp || undefined); out.textContent = 'Updated.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(updateBtn, false); }
  });

  deleteBtn?.addEventListener('click', async () => {
    const sd = subdomainEl.value.trim();
    if (!sd) { out.textContent = 'Enter subdomain.'; return; }
    setBusy(deleteBtn, true);
    try { await puter.hosting.delete(sd); out.textContent = 'Deleted.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(deleteBtn, false); }
  });

  document.getElementById('host-get')?.addEventListener('click', async () => {
    const sd = subdomainEl.value.trim(); if (!sd) { out.textContent = 'Enter subdomain.'; return; }
    try { const site = await puter.hosting.get(sd); out.textContent = JSON.stringify(site); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  document.getElementById('host-list')?.addEventListener('click', async () => {
    try { const sites = await puter.hosting.list(); out.textContent = JSON.stringify(sites?.map(s=>s.subdomain)); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
})();

// Networking
(() => {
  const out = document.getElementById('networking-output');
  const fetchBtn = document.getElementById('net-fetch');
  const urlEl = document.getElementById('net-url');
  const sockBtn = document.getElementById('net-socket');
  const tlsBtn = document.getElementById('net-tls');

  fetchBtn?.addEventListener('click', async () => {
    const url = urlEl.value.trim();
    if (!url) { out.textContent = 'Enter URL.'; return; }
    setBusy(fetchBtn, true);
    try {
      const resp = await puter.net.fetch(url);
      const text = await resp.text();
      out.textContent = text.slice(0, 5000);
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(fetchBtn, false); }
  });

  sockBtn?.addEventListener('click', () => {
    out.textContent = '';
    try {
      const socket = new puter.net.Socket('example.com', 80);
      const decoder = new TextDecoder();
      socket.on('open', () => {
        out.textContent += '[TCP] open\n';
        socket.write('GET / HTTP/1.1\r\nHost: example.com\r\n\r\n');
      });
      socket.on('data', (data) => {
        out.textContent += decoder.decode(data);
      });
      socket.on('error', (reason) => {
        out.textContent += `\n[TCP] error: ${reason}`;
      });
      socket.on('close', (hadError) => {
        out.textContent += `\n[TCP] close (hadError=${hadError})`;
      });
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    }
  });

  tlsBtn?.addEventListener('click', () => {
    out.textContent = '';
    try {
      const socket = new puter.net.tls.TLSSocket('example.com', 443);
      socket.on('open', () => {
        out.textContent += '[TLS] open\n';
        socket.write('GET / HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n');
      });
      socket.on('data', (data) => {
        const decoder = new TextDecoder();
        out.textContent += decoder.decode(data);
      });
      socket.on('error', (reason) => {
        out.textContent += `\n[TLS] error: ${reason}`;
      });
      socket.on('close', () => {
        out.textContent += '\n[TLS] close';
      });
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    }
  });
})();

// Workers
(() => {
  const out = document.getElementById('workers-output');
  const deployBtn = document.getElementById('worker-deploy');
  const testBtn = document.getElementById('worker-test');
  let lastWorkerUrl = '';

  deployBtn?.addEventListener('click', async () => {
    setBusy(deployBtn, true);
    out.textContent = '';
    try {
      const workerName = puter.randName();
      const code = `router.get('/api/hello', async () => { return { msg: 'Hello from worker!' }; });`;
      await puter.fs.write('my-worker.js', code, { overwrite: true });
      const deployment = await puter.workers.create(workerName, 'my-worker.js');
      lastWorkerUrl = deployment.url;
      out.textContent = `Deployed at: ${deployment.url}`;
    } catch (e) {
      out.textContent = 'Error: ' + (e?.message || e);
    } finally { setBusy(deployBtn, false); }
  });

  testBtn?.addEventListener('click', async () => {
    if (!lastWorkerUrl) { out.textContent = 'Deploy a worker first.'; return; }
    setBusy(testBtn, true);
    try {
      const resp = await puter.workers.exec(`${lastWorkerUrl}/api/hello`);
      const data = await resp.json();
      out.textContent = JSON.stringify(data);
    } catch (e) {
      out.textContent = 'Error (Note: propagation can take ~5–30s): ' + (e?.message || e);
    } finally { setBusy(testBtn, false); }
  });
})();

// UI & Pickers
(() => {
  const out = document.getElementById('ui-output');
  const openFileBtn = document.getElementById('ui-open-file');
  const saveFileBtn = document.getElementById('ui-save-file');
  const openDirBtn = document.getElementById('ui-open-dir');
  const colorBtn = document.getElementById('ui-color');
  const fontBtn = document.getElementById('ui-font');
  const langBtn = document.getElementById('ui-language');

  openFileBtn?.addEventListener('click', async () => {
    try {
      const file = await puter.ui.showOpenFilePicker();
      const name = file?.name || (Array.isArray(file) ? file.map(f => f.name).join(', ') : '');
      const content = file?.read ? await (await file.read()).text() : '';
      out.textContent = `Opened: ${name}\n${content?.slice(0, 5000)}`;
    } catch (e) { out.textContent = 'Cancelled or error.'; }
  });

  saveFileBtn?.addEventListener('click', async () => {
    try {
      const file = await puter.ui.showSaveFilePicker("Hello from Puter.js!", 'Untitled.txt');
      out.textContent = `Saved: ${file?.name}`;
    } catch (e) { out.textContent = 'Cancelled or error.'; }
  });

  openDirBtn?.addEventListener('click', async () => {
    try {
      const dir = await puter.ui.showDirectoryPicker();
      const items = await dir.readdir();
      out.textContent = `Dir: ${dir.name}\nItems: ${(items||[]).map(i=>i.name).join(', ')}`;
    } catch (e) { out.textContent = 'Cancelled or error.'; }
  });

  colorBtn?.addEventListener('click', async () => {
    try {
      const color = await puter.ui.showColorPicker();
      document.body.style.backgroundColor = color;
      out.textContent = `Color: ${color}`;
    } catch (e) { out.textContent = 'Cancelled or error.'; }
  });

  fontBtn?.addEventListener('click', async () => {
    try {
      const font = await puter.ui.showFontPicker();
      document.body.style.fontFamily = font.fontFamily;
      out.textContent = `Font: ${JSON.stringify(font)}`;
    } catch (e) { out.textContent = 'Cancelled or error.'; }
  });

  langBtn?.addEventListener('click', async () => {
    try {
      const lang = await puter.ui.getLanguage();
      out.textContent = `Language: ${lang}`;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
})();

// FS Extras
(() => {
  const out = document.getElementById('fsx-output');
  const mkdirBtn = document.getElementById('fs-mkdir');
  const readdirBtn = document.getElementById('fs-readdir');
  const mkdirPath = document.getElementById('mkdir-path');
  const readdirPath = document.getElementById('readdir-path');

  mkdirBtn?.addEventListener('click', async () => {
    const p = mkdirPath.value.trim();
    if (!p) { out.textContent = 'Enter a directory path.'; return; }
    setBusy(mkdirBtn, true);
    try {
      const dir = await puter.fs.mkdir(p, { createMissingParents: true, dedupeName: true });
      out.textContent = `Created: ${dir.path}`;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(mkdirBtn, false); }
  });

  readdirBtn?.addEventListener('click', async () => {
    const p = readdirPath.value.trim() || './';
    setBusy(readdirBtn, true);
    try {
      const items = await puter.fs.readdir(p);
      out.textContent = (items || []).map(i => `${i.is_dir ? '[D]' : '[F]'} ${i.name}`).join('\n') || '(empty)';
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(readdirBtn, false); }
  });
})();

// Apps API
(() => {
  const out = document.getElementById('apps-output');
  const nameEl = document.getElementById('apps-name');
  const indexEl = document.getElementById('apps-index');
  const btnCreate = document.getElementById('apps-create');
  const btnList = document.getElementById('apps-list');
  const btnGet = document.getElementById('apps-get');
  const btnUpdate = document.getElementById('apps-update');
  const btnDelete = document.getElementById('apps-delete');

  btnCreate?.addEventListener('click', async () => {
    const name = nameEl.value.trim() || puter.randName();
    const indexURL = indexEl.value.trim() || 'https://example.com';
    setBusy(btnCreate, true);
    try {
      const app = await puter.apps.create(name, indexURL);
      nameEl.value = app.name;
      out.textContent = `Created: ${app.name} UID=${app.uid}`;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnCreate, false); }
  });

  btnList?.addEventListener('click', async () => {
    setBusy(btnList, true);
    try { const apps = await puter.apps.list(); out.textContent = JSON.stringify(apps?.map(a=>a.name)); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnList, false); }
  });

  btnGet?.addEventListener('click', async () => {
    const name = nameEl.value.trim();
    if (!name) { out.textContent = 'Enter App Name.'; return; }
    setBusy(btnGet, true);
    try { const app = await puter.apps.get(name); out.textContent = JSON.stringify(app); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnGet, false); }
  });

  btnUpdate?.addEventListener('click', async () => {
    const name = nameEl.value.trim();
    if (!name) { out.textContent = 'Enter App Name.'; return; }
    setBusy(btnUpdate, true);
    try { const updated = await puter.apps.update(name, { title: 'Updated Title' }); out.textContent = 'Updated: ' + updated.title; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnUpdate, false); }
  });

  btnDelete?.addEventListener('click', async () => {
    const name = nameEl.value.trim();
    if (!name) { out.textContent = 'Enter App Name.'; return; }
    setBusy(btnDelete, true);
    try { await puter.apps.delete(name); out.textContent = 'Deleted.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnDelete, false); }
  });
})();

// FS more
(() => {
  const out = document.getElementById('fs-more-output');
  const srcEl = document.getElementById('fs-src');
  const destEl = document.getElementById('fs-dest');
  const btnRename = document.getElementById('fs-rename');
  const btnCopy = document.getElementById('fs-copy');
  const btnMove = document.getElementById('fs-move');
  const btnDelete = document.getElementById('fs-delete');
  const btnStat = document.getElementById('fs-stat');
  const btnReadUrl = document.getElementById('fs-readurl');
  const btnUpload = document.getElementById('fs-upload');
  const btnSpace = document.getElementById('fs-space');

  btnRename?.addEventListener('click', async () => {
    const p = srcEl.value.trim(); const n = destEl.value.trim();
    if (!p || !n) { out.textContent = 'Enter source and new name.'; return; }
    setBusy(btnRename, true);
    try { const r = await puter.fs.rename(p, n); out.textContent = 'Renamed.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnRename, false); }
  });

  btnCopy?.addEventListener('click', async () => {
    const s = srcEl.value.trim(); const d = destEl.value.trim();
    if (!s || !d) { out.textContent = 'Enter source and destination.'; return; }
    setBusy(btnCopy, true);
    try { await puter.fs.copy(s, d, { dedupeName: true }); out.textContent = 'Copied.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnCopy, false); }
  });

  btnMove?.addEventListener('click', async () => {
    const s = srcEl.value.trim(); const d = destEl.value.trim();
    if (!s || !d) { out.textContent = 'Enter source and destination.'; return; }
    setBusy(btnMove, true);
    try { await puter.fs.move(s, d, { createMissingParents: true }); out.textContent = 'Moved.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnMove, false); }
  });

  btnDelete?.addEventListener('click', async () => {
    const p = srcEl.value.trim();
    if (!p) { out.textContent = 'Enter path to delete.'; return; }
    setBusy(btnDelete, true);
    try { await puter.fs.delete(p); out.textContent = 'Deleted.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnDelete, false); }
  });

  btnStat?.addEventListener('click', async () => {
    const p = srcEl.value.trim();
    if (!p) { out.textContent = 'Enter path for stat.'; return; }
    setBusy(btnStat, true);
    try { const info = await puter.fs.stat(p); out.textContent = JSON.stringify(info); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnStat, false); }
  });

  btnReadUrl?.addEventListener('click', async () => {
    const p = srcEl.value.trim();
    if (!p) { out.textContent = 'Enter file path for read URL.'; return; }
    setBusy(btnReadUrl, true);
    try { const url = await puter.fs.getReadURL(p); out.textContent = url; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnReadUrl, false); }
  });

  btnUpload?.addEventListener('click', async () => {
    setBusy(btnUpload, true);
    try {
      const picker = document.createElement('input');
      picker.type = 'file';
      picker.multiple = true;
      picker.onchange = async () => {
        try {
          const files = await puter.fs.upload(picker.files);
          out.textContent = 'Uploaded: ' + JSON.stringify((files||[]).map(f=>f.path));
        } catch (err) { out.textContent = 'Error: ' + (err?.message || err); }
        finally { setBusy(btnUpload, false); }
      };
      picker.click();
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); setBusy(btnUpload, false); }
  });

  btnSpace?.addEventListener('click', async () => {
    setBusy(btnSpace, true);
    try { const space = await puter.fs.space(); out.textContent = JSON.stringify(space); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnSpace, false); }
  });
})();

// KV incr/decr
(() => {
  const out = document.getElementById('kvid-output');
  const keyEl = document.getElementById('kvid-key');
  const btnIncr = document.getElementById('kv-incr');
  const btnDecr = document.getElementById('kv-decr');

  btnIncr?.addEventListener('click', async () => {
    const k = keyEl.value.trim() || 'counter';
    setBusy(btnIncr, true);
    try { const v = await puter.kv.incr(k); out.textContent = `New value: ${v}`; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnIncr, false); }
  });

  btnDecr?.addEventListener('click', async () => {
    const k = keyEl.value.trim() || 'counter';
    setBusy(btnDecr, true);
    try { const v = await puter.kv.decr(k); out.textContent = `New value: ${v}`; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnDecr, false); }
  });
})();

// Workers more
(() => {
  const out = document.getElementById('workers-more-output');
  const nameEl = document.getElementById('workers-name');
  const btnList = document.getElementById('workers-list');
  const btnGet = document.getElementById('workers-get');
  const btnDelete = document.getElementById('workers-delete');

  btnList?.addEventListener('click', async () => {
    setBusy(btnList, true);
    try { const list = await puter.workers.list(); out.textContent = JSON.stringify(list); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnList, false); }
  });

  btnGet?.addEventListener('click', async () => {
    const n = nameEl.value.trim(); if (!n) { out.textContent = 'Enter worker name.'; return; }
    setBusy(btnGet, true);
    try { const info = await puter.workers.get(n); out.textContent = JSON.stringify(info); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnGet, false); }
  });

  btnDelete?.addEventListener('click', async () => {
    const n = nameEl.value.trim(); if (!n) { out.textContent = 'Enter worker name.'; return; }
    setBusy(btnDelete, true);
    try { const ok = await puter.workers.delete(n); out.textContent = 'Deleted: ' + ok; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
    finally { setBusy(btnDelete, false); }
  });
})();

// UI extras
(() => {
  const out = document.getElementById('ui-extras-output');
  const alertBtn = document.getElementById('ui-alert');
  const windowBtn = document.getElementById('ui-window');
  const spinnerBtn = document.getElementById('ui-spinner');
  const contextBtn = document.getElementById('ui-context');
  const menubarBtn = document.getElementById('ui-menubar');
  const shareBtn = document.getElementById('ui-share');
  const ctxArea = document.getElementById('ui-context-area');
  const authBtn = document.getElementById('ui-authenticate');
  const launchBtn = document.getElementById('ui-launch-app');
  const parentBtn = document.getElementById('ui-parent-app');
  const onBtn = document.getElementById('ui-on-register');
  const onCloseBtn = document.getElementById('ui-on-window-close');
  const itemsBtn = document.getElementById('ui-items-handlers');
  const titleBtn = document.getElementById('ui-title');
  const sizeBtn = document.getElementById('ui-size');
  const posBtn = document.getElementById('ui-position');
  const widthBtn = document.getElementById('ui-width');
  const heightBtn = document.getElementById('ui-height');
  const xBtn = document.getElementById('ui-x');
  const yBtn = document.getElementById('ui-y');

  alertBtn?.addEventListener('click', async () => {
    try {
      const val = await puter.ui.alert('Please choose:', [
        { label: 'Hello :)', value: 'hello', type: 'primary' },
        { label: 'Bye :(', type: 'danger' },
        { label: 'Cancel' },
      ]);
      out.textContent = 'Alert result: ' + val;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  document.getElementById('ui-prompt')?.addEventListener('click', async () => {
    try {
      const val = await puter.ui.prompt('Enter your name');
      out.textContent = 'Prompt result: ' + val;
    } catch (e) { out.textContent = 'Cancelled or error.'; }
  });

  windowBtn?.addEventListener('click', () => {
    puter.ui.createWindow({ title: 'Demo Window', content: '<h2 style="text-align:center;">Hello!</h2>', width: 320, height: 220, center: true, has_head: true, is_resizable: false, show_in_taskbar: false });
  });

  spinnerBtn?.addEventListener('click', () => {
    puter.ui.showSpinner();
    setTimeout(()=> puter.ui.hideSpinner(), 3000);
    out.textContent = 'Spinner shown for 3 seconds.';
  });

  contextBtn?.addEventListener('click', () => {
    ctxArea.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      puter.ui.contextMenu({ items: [
        { label: 'Edit Item', action: () => out.textContent = 'Edit clicked' },
        { label: 'Copy Item', action: () => out.textContent = 'Copy clicked' },
        '-',
        { label: 'Delete Item', action: () => out.textContent = 'Delete clicked' }
      ]});
    }, { once: true });
    out.textContent = 'Right-click enabled in the box.';
  });

  menubarBtn?.addEventListener('click', () => {
    puter.ui.setMenubar({ items: [
      { label: 'File', items: [
        { label: 'Action', action: () => out.textContent = 'Menubar action' },
        { label: 'Sub-Menu', items: [
          { label: 'Action 1', action: () => out.textContent = 'Action 1' },
          { label: 'Action 2', action: () => out.textContent = 'Action 2' },
        ]}
      ]}
    ]});
    out.textContent = 'Menubar set.';
  });

  shareBtn?.addEventListener('click', async () => {
    try { await puter.ui.socialShare('https://developer.puter.com', 'Check Puter.js!'); out.textContent = 'Share dialog opened.'; }
    catch (e) { out.textContent = 'Error or canceled.'; }
  });

  authBtn?.addEventListener('click', async () => {
    try { const user = await puter.ui.authenticateWithPuter(); out.textContent = 'Authenticated'; }
    catch (e) { out.textContent = 'Cancelled or error.'; }
  });

  launchBtn?.addEventListener('click', async () => {
    try { const child = await puter.ui.launchApp(); out.textContent = 'Launched current app.'; }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  parentBtn?.addEventListener('click', () => {
    const parent = puter.ui.parentApp();
    out.textContent = parent ? 'Has parent app connection.' : 'No parent app.';
  });

  onBtn?.addEventListener('click', () => {
    try {
      puter.ui.on('localeChanged', (loc) => { out.textContent = `localeChanged: ${loc?.language}`; });
      puter.ui.on('themeChanged', (t) => { out.textContent = `themeChanged: hue=${t?.palette?.primaryHue}`; });
      out.textContent = 'Registered UI on() handlers.';
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  onCloseBtn?.addEventListener('click', () => {
    puter.ui.onWindowClose(() => {
      alert('Window is about to close!');
      puter.exit();
    });
    out.textContent = 'onWindowClose handler registered (click window X).';
  });

  itemsBtn?.addEventListener('click', () => {
    puter.ui.onLaunchedWithItems((items) => { out.textContent = 'Launched with items: ' + JSON.stringify(items); });
    puter.ui.onItemsOpened((items) => { out.textContent = 'Items opened: ' + JSON.stringify(items); });
    const was = puter.ui.wasLaunchedWithItems();
    out.textContent = 'Item handlers set. wasLaunchedWithItems=' + was;
  });

  titleBtn?.addEventListener('click', () => { puter.ui.setWindowTitle('Demo Title'); out.textContent = 'Title set.'; });
  sizeBtn?.addEventListener('click', () => { puter.ui.setWindowSize(900, 600); out.textContent = 'Size set 900x600.'; });
  posBtn?.addEventListener('click', () => { puter.ui.setWindowPosition(60, 80); out.textContent = 'Position set 60,80.'; });
  widthBtn?.addEventListener('click', () => { puter.ui.setWindowWidth(840); out.textContent = 'Width set 840.'; });
  heightBtn?.addEventListener('click', () => { puter.ui.setWindowHeight(520); out.textContent = 'Height set 520.'; });
  xBtn?.addEventListener('click', () => { puter.ui.setWindowX(120); out.textContent = 'X set 120.'; });
  yBtn?.addEventListener('click', () => { puter.ui.setWindowY(140); out.textContent = 'Y set 140.'; });
})();

// Utils
(() => {
  const out = document.getElementById('utils-output');
  const envBtn = document.getElementById('util-env');
  const appBtn = document.getElementById('util-appid');
  const randBtn = document.getElementById('util-rand');
  const printBtn = document.getElementById('util-print');

  envBtn?.addEventListener('click', () => { out.textContent = 'env: ' + puter.env; });
  appBtn?.addEventListener('click', () => { out.textContent = 'appID: ' + puter.appID; });
  randBtn?.addEventListener('click', () => { out.textContent = 'randName: ' + puter.randName(); });
  printBtn?.addEventListener('click', () => { puter.print('Hello, world! (printed to page)'); out.textContent = 'Called puter.print()'; });
})();

// Drivers.call (illustrative)
(() => {
  const out = document.getElementById('drivers-output');
  const ifaceEl = document.getElementById('drv-interface');
  const drvEl = document.getElementById('drv-driver');
  const methodEl = document.getElementById('drv-method');
  const argsEl = document.getElementById('drv-args');
  const btn = document.getElementById('drv-call');

  btn?.addEventListener('click', async () => {
    const iface = ifaceEl.value.trim();
    const driver = drvEl.value.trim();
    const method = methodEl.value.trim();
    let args;
    try { args = argsEl.value.trim() ? JSON.parse(argsEl.value) : {}; } catch { args = {}; }
    if (!iface || !driver || !method) { out.textContent = 'Enter interface, driver, and method.'; return; }
    setBusy(btn, true);
    try {
      const res = await puter.drivers.call(iface, driver, method, args);
      out.textContent = 'Result: ' + JSON.stringify(res);
    } catch (e) {
      out.textContent = 'Error (may require privileges): ' + (e?.message || e);
    } finally { setBusy(btn, false); }
  });
})();

// Perms (illustrative)
(() => {
  const out = document.getElementById('perms-output');
  const appUidEl = document.getElementById('perms-app-uid');
  const originEl = document.getElementById('perms-origin');
  const groupUidEl = document.getElementById('perms-group-uid');
  const userEl = document.getElementById('perms-username');
  const permEl = document.getElementById('perms-string');

  function showErr(e){ out.textContent = 'Error (likely needs privilege): ' + (e?.message || e); }

  document.getElementById('perms-grant-app')?.addEventListener('click', async () => {
    try { await puter.perms.grantApp(appUidEl.value.trim(), permEl.value.trim()); out.textContent = 'grantApp OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-revoke-app')?.addEventListener('click', async () => {
    try { await puter.perms.revokeApp(appUidEl.value.trim(), permEl.value.trim()); out.textContent = 'revokeApp OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-grant-app-any')?.addEventListener('click', async () => {
    try { await puter.perms.grantAppAnyUser(appUidEl.value.trim(), permEl.value.trim()); out.textContent = 'grantAppAnyUser OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-revoke-app-any')?.addEventListener('click', async () => {
    try { await puter.perms.revokeAppAnyUser(appUidEl.value.trim(), permEl.value.trim()); out.textContent = 'revokeAppAnyUser OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-grant-origin')?.addEventListener('click', async () => {
    try { await puter.perms.grantOrigin(originEl.value.trim(), permEl.value.trim()); out.textContent = 'grantOrigin OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-revoke-origin')?.addEventListener('click', async () => {
    try { await puter.perms.revokeOrigin(originEl.value.trim(), permEl.value.trim()); out.textContent = 'revokeOrigin OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-grant-group')?.addEventListener('click', async () => {
    try { await puter.perms.grantGroup(groupUidEl.value.trim(), permEl.value.trim()); out.textContent = 'grantGroup OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-revoke-group')?.addEventListener('click', async () => {
    try { await puter.perms.revokeGroup(groupUidEl.value.trim(), permEl.value.trim()); out.textContent = 'revokeGroup OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-grant-user')?.addEventListener('click', async () => {
    try { await puter.perms.grantUser(userEl.value.trim(), permEl.value.trim()); out.textContent = 'grantUser OK'; } catch (e) { showErr(e); }
  });
  document.getElementById('perms-revoke-user')?.addEventListener('click', async () => {
    try { await puter.perms.revokeUser(userEl.value.trim(), permEl.value.trim()); out.textContent = 'revokeUser OK'; } catch (e) { showErr(e); }
  });
})();

// AppConnection: parent/child message demo
(() => {
  const parent = puter.ui.parentApp();
  if (parent) {
    // We are a child: respond to messages and send back
    parent.on('message', (msg) => {
      try { puter.ui.alert('Parent says: ' + (typeof msg === 'object' ? JSON.stringify(msg) : msg)); } catch {}
      parent.postMessage({ received: true, at: Date.now() });
    });
  }
})();

// AI Advanced
(() => {
  const out = document.getElementById('ai-advanced-output');
  const btnImg = document.getElementById('ai-chat-image');
  const btnMsgs = document.getElementById('ai-chat-messages');
  const btnTools = document.getElementById('ai-chat-tools');
  const imgUrlEl = document.getElementById('ai-img-url');
  const msgTextEl = document.getElementById('ai-msg-text');
  const txt2imgModelEl = document.getElementById('ai-txt2img-model');
  const txt2imgQualityEl = document.getElementById('ai-txt2img-quality');
  const txt2imgOptsBtn = document.getElementById('ai-txt2img-opts');
  const ttsEngineEl = document.getElementById('tts-engine');
  const ttsEngineBtn = document.getElementById('tts-play-engine');
  const i2iFile = document.getElementById('ai-i2i-file');
  const i2iPrompt = document.getElementById('ai-i2i-prompt');
  const i2iBtn = document.getElementById('ai-txt2img-i2i');

  btnImg?.addEventListener('click', async () => {
    const url = imgUrlEl.value.trim() || 'https://assets.puter.site/doge.jpeg';
    out.textContent = '';
    try {
      const resp = await puter.ai.chat('What do you see?', url, { model: 'gpt-5-nano' });
      const text = typeof resp === 'string' ? resp : (resp?.message?.content || resp?.toString?.() || '');
      out.textContent = text;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  btnMsgs?.addEventListener('click', async () => {
    const text = msgTextEl.value.trim() || 'Say hello in 1 sentence';
    out.textContent = '';
    try {
      const resp = await puter.ai.chat([
        { role: 'system', content: 'You are concise.' },
        { role: 'user', content: text }
      ]);
      const content = typeof resp === 'string' ? resp : (resp?.message?.content || resp?.toString?.() || '');
      out.textContent = content;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  btnTools?.addEventListener('click', async () => {
    out.textContent = '';
    try {
      const tools = [{
        type: 'function',
        function: {
          name: 'get_weather',
          description: 'Get current weather for a given location',
          parameters: { type: 'object', properties: { location: { type: 'string' } }, required: ['location'] }
        }
      }];
      const completion = await puter.ai.chat('What is the weather in Paris?', { tools });
      out.textContent = JSON.stringify(completion?.message?.tool_calls || completion);
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  txt2imgOptsBtn?.addEventListener('click', async () => {
    const prompt = document.getElementById('img-prompt')?.value?.trim() || 'A picture of a cat.';
    const model = txt2imgModelEl.value.trim() || 'gpt-image-1';
    const quality = txt2imgQualityEl.value.trim() || 'low';
    out.textContent = '';
    try {
      const imgEl = await puter.ai.txt2img(prompt, { model, quality });
      const host = document.getElementById('img-output');
      if (imgEl instanceof HTMLImageElement) { imgEl.classList.add('preview'); host?.appendChild(imgEl); }
      else if (typeof imgEl === 'string') { const img = new Image(); img.src = imgEl; img.className = 'preview'; host?.appendChild(img); }
      out.textContent = `Generated with model=${model} quality=${quality}`;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  i2iBtn?.addEventListener('click', async () => {
    const file = i2iFile.files?.[0];
    const prompt = i2iPrompt.value.trim() || 'Transform this image subtly';
    if (!file) { out.textContent = 'Choose an input image file.'; return; }
    out.textContent = '';
    try {
      const b64 = await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result).split(',')[1] || '');
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
      const mime = file.type || 'image/png';
      const imgEl = await puter.ai.txt2img(prompt, {
        model: 'gemini-2.5-flash-image-preview',
        input_image: b64,
        input_image_mime_type: mime
      });
      const host = document.getElementById('img-output');
      if (imgEl instanceof HTMLImageElement) { imgEl.classList.add('preview'); host?.appendChild(imgEl); }
      else if (typeof imgEl === 'string') { const img = new Image(); img.src = imgEl; img.className = 'preview'; host?.appendChild(img); }
      out.textContent = `Image-to-image done (mime=${mime}).`;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });

  ttsEngineBtn?.addEventListener('click', async () => {
    const text = document.getElementById('tts-text')?.value?.trim() || 'Hello world!';
    const language = document.getElementById('tts-lang')?.value?.trim() || 'en-US';
    const voice = document.getElementById('tts-voice')?.value?.trim() || 'Joanna';
    const engine = ttsEngineEl.value.trim() || 'standard';
    out.textContent = '';
    try {
      const audio = await puter.ai.txt2speech(text, { language, voice, engine });
      await audio.play();
      out.textContent = `Playing with engine=${engine}`;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
})();

// Auth Advanced
(() => {
  const out = document.getElementById('auth-advanced-output');
  const btn = document.getElementById('auth-temp-user');
  btn?.addEventListener('click', async () => {
    try { const res = await puter.auth.signIn({ attempt_temp_user_creation: true }); out.textContent = 'Signed in (temp ok): ' + JSON.stringify(res); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
})();

// KV Advanced
(() => {
  const out = document.getElementById('kv-advanced-output');
  const patternEl = document.getElementById('kv-pattern');
  document.getElementById('kv-list-pattern')?.addEventListener('click', async () => {
    try { const keys = await puter.kv.list(patternEl.value.trim() || '*'); out.textContent = JSON.stringify(keys); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
  document.getElementById('kv-list-values')?.addEventListener('click', async () => {
    try { const keys = await puter.kv.list(true); out.textContent = JSON.stringify(keys); }
    catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
})();

// FS Read Advanced
(() => {
  const out = document.getElementById('fs-read-advanced-output');
  const pathEl = document.getElementById('fs-read-path');
  const offEl = document.getElementById('fs-offset');
  const bcEl = document.getElementById('fs-bytecount');
  document.getElementById('fs-read-slice')?.addEventListener('click', async () => {
    const p = pathEl.value.trim();
    const offset = Number(offEl.value || 0);
    const byte_count = Number(bcEl.value || 0);
    if (!p || isNaN(offset) || isNaN(byte_count) || byte_count <= 0) { out.textContent = 'Provide file path, offset, and positive byte_count.'; return; }
    try {
      const blob = await puter.fs.read(p, { offset, byte_count });
      const text = await blob.text();
      out.textContent = text;
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
})();

// Networking POST
(() => {
  const out = document.getElementById('net-post-output');
  const urlEl = document.getElementById('net-post-url');
  const bodyEl = document.getElementById('net-post-body');
  document.getElementById('net-post-send')?.addEventListener('click', async () => {
    const url = urlEl.value.trim();
    let body;
    try { body = JSON.parse(bodyEl.value || '{}'); } catch { body = { raw: bodyEl.value }; }
    if (!url) { out.textContent = 'Enter URL.'; return; }
    try {
      const resp = await puter.net.fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const text = await resp.text();
      out.textContent = text.slice(0, 5000);
    } catch (e) { out.textContent = 'Error: ' + (e?.message || e); }
  });
})();
